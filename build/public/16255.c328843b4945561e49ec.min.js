(self.webpackChunknodebb=self.webpackChunknodebb||[]).push([[6232,16255,33085,34405,73848],{34405:(b,k,m)=>{"use strict";var w,C;w=[m(49897),m(29930)],C=function(x,y){const d={},p={delay:200,appendTo:null};d.init=n=>{const s={...p,...n},{input:i,onSelect:l}=s;app.loadJQueryUI(function(){i.autocomplete({...s,open:function(){$(this).autocomplete("widget").css("z-index",100005)},select:function(r,u){h(i,l,r,u)}})})},d.user=function(n,s,i){typeof s=="function"&&(i=s,s={}),s=s||{},d.init({input:n,onSelect:i,source:(l,r)=>{s.query=l.term,x.get("/api/users",s,function(u,f){if(u)return y.error(u);if(f&&f.users){const g=f.users.map(function(E){const A=$("<div></div>").html(E.username).text();return E&&{label:A,value:A,user:{uid:E.uid,name:E.username,slug:E.userslug,username:E.username,userslug:E.userslug,picture:E.picture,banned:E.banned,"icon:text":E["icon:text"],"icon:bgColor":E["icon:bgColor"]}}});r(g)}$(".ui-autocomplete a").attr("data-ajaxify","false")})}})},d.group=function(n,s){d.init({input:n,onSelect:s,source:(i,l)=>{socket.emit("groups.search",{query:i.term},function(r,u){if(r)return y.error(r);if(u&&u.length){const f=u.map(function(g){return g&&{label:g.name,value:g.name,group:g}});l(f)}$(".ui-autocomplete a").attr("data-ajaxify","false")})}})},d.tag=function(n,s){d.init({input:n,onSelect:s,delay:100,source:(i,l)=>{socket.emit("topics.autocompleteTags",{query:i.term,cid:ajaxify.data.cid||0},function(r,u){if(r)return y.error(r);u&&l(u),$(".ui-autocomplete a").attr("data-ajaxify","false")})}})};function h(n,s,i,l){s=s||function(){};const r=jQuery.Event("keypress");r.which=13,r.keyCode=13,setTimeout(function(){n.trigger(r)},100),s(i,l)}return d}.apply(k,w),C!==void 0&&(b.exports=C)},38636:(b,k,m)=>{"use strict";var w,C;w=[m(52473),m(6411),m(26832),m(80083),m(58836),m(60419),m(72513),m(65161),m(93230),m(88518),m(91749),m(40027),m(29930),m(92619),m(49897),m(43103)],C=function(x,y,d,p,h,n,s,i,l,r,u,f,g,E,A,S){const o={initialised:!1,activeAutocomplete:{}};let L=!1,T=null;return $(window).on("action:ajaxify.start",function(){o.destroyAutoComplete(ajaxify.data.roomId),ajaxify.data.template.chats&&(ajaxify.data.roomId&&socket.emit("modules.chats.leave",ajaxify.data.roomId),ajaxify.data.publicRooms&&socket.emit("modules.chats.leavePublic",ajaxify.data.publicRooms.map(e=>e.roomId)))}),o.init=function(){utils.isMobile()||$('.chats-full [data-bs-toggle="tooltip"]').tooltip({trigger:"hover",container:"#content"}),socket.emit("modules.chats.enterPublic",ajaxify.data.publicRooms.map(a=>a.roomId));const e=utils.findBootstrapEnvironment();T=$('[component="chat/nav-wrapper"]'),o.initialised||(o.addSocketListeners(),o.addGlobalEventListeners()),d.init(),o.addEventListeners(),o.setActive(ajaxify.data.roomId),(e==="md"||e==="lg"||e==="xl"||e==="xxl")&&o.addHotkeys(),o.initialised=!0;const t=$('[component="chat/message/content"]');if(n.wrapImagesInLinks(t),ajaxify.data.scrollToIndex){n.toggleScrollUpAlert(t);const a=t.find(`[data-index="${ajaxify.data.scrollToIndex-1}"]`);a.length&&t.scrollTop(t.scrollTop()-t.offset().top+a.offset().top)}else n.scrollToBottomAfterImageLoad(t);p.init(),u.fire("action:chat.loaded",$(".chats-full"))},o.addEventListeners=function(){const{roomId:e}=ajaxify.data,t=$('[component="chat/main-wrapper"]'),a=$('[component="chat/message/content"]'),c=x.get("chat/controls");o.addSendHandlers(e,$(".chat-input"),$('.expanded-chat button[data-action="send"]')),o.addPopoutHandler(),o.addActionHandlers(x.get("chat/message/window"),e),o.addManageHandler(e,c.find('[data-action="manage"]')),o.addRenameHandler(e,c.find('[data-action="rename"]')),o.addLeaveHandler(e,c.find('[data-action="leave"]')),o.addDeleteHandler(e,c.find('[data-action="delete"]')),o.addScrollHandler(e,ajaxify.data.uid,a),o.addScrollBottomHandler(e,a),o.addParentHandler(t),o.addCharactersLeftHandler(t),o.addTextareaResizeHandler(t),o.addTypingHandler(t,e),o.addIPHandler(t),o.addCopyTextLinkHandler(t),o.createAutoComplete(e,$('[component="chat/input"]')),o.addUploadHandler({dragDropAreaEl:$(".chats-full"),pasteEl:$('[component="chat/input"]'),uploadFormEl:$('[component="chat/upload"]'),uploadBtnEl:$('[component="chat/upload/button"]'),inputEl:$('[component="chat/input"]')}),$('[data-action="close"]').on("click",function(){o.switchChat()}),s.init(e,t),o.addNotificationSettingHandler(e,t),i.init(e,t),o.addPublicRoomSortHandler(),o.addTooltipHandler(t),l.init(t)},o.addPublicRoomSortHandler=function(){app.user.isAdmin&&!utils.isMobile()&&app.loadJQueryUI(()=>{const e=$('[component="chat/public"]');e.sortable({handle:'[component="chat/public/room/sort/handle"]',items:'[component="chat/public/room"]',axis:"y",update:async function(){const t={roomIds:[],scores:[]};e.find("[data-roomid]").each((a,c)=>{t.roomIds.push($(c).attr("data-roomid")),t.scores.push(a)}),await A.put("/chats/sort",t)}})})},o.addTooltipHandler=function(e){utils.isMobile()||(e.find("[data-manual-tooltip]").tooltip({trigger:"manual",animation:!1,placement:"bottom"}).on("mouseenter",function(t){const a=$(t.target);a.hasClass("dropdown-menu")||!!a.parents(".dropdown-menu").length||$(this).tooltip("show")}).on("click mouseleave",function(){$(this).tooltip("hide")}),e.tooltip({selector:'[component="chat/message/controls"] > .btn-group > button',placement:"top",container:"#content",animation:!1,trigger:"hover"}))},o.addNotificationSettingHandler=function(e,t){const a=t.find('[component="chat/notification/setting"]');a.find("[data-value]").on("click",async function(){a.find("i.fa-check").addClass("hidden");const c=$(this);c.find("i.fa-check").removeClass("hidden"),a.find('[component="chat/notification/setting/icon"]').attr("class",`fa ${c.attr("data-icon")}`),await A.put(`/chats/${e}/watch`,{value:c.attr("data-value")})})},o.addParentHandler=function(e){e.off("click",'[component="chat/message/parent"]').on("click",'[component="chat/message/parent"]',function(){const t=$(this);t.find('[component="chat/message/parent/content"]').toggleClass("line-clamp-1"),t.find(".chat-timestamp").toggleClass("hidden"),t.toggleClass("flex-column").toggleClass("flex-row");const a=t.parents('[component="chat/message/content"]');a.length&&n.isAtBottom(a)&&n.scrollToBottom(a)})},o.addUploadHandler=function(e){S.init({dragDropAreaEl:e.dragDropAreaEl,pasteEl:e.pasteEl,uploadFormEl:e.uploadFormEl,uploadBtnEl:e.uploadBtnEl,route:"/api/post/upload",callback:function(t){const a=e.inputEl;let c=a.val();t.forEach(v=>{c=c+(c.endsWith(`
`)?"":`
`)+(v.isImage?"!":"")+`[${v.filename}](${v.url})
`}),a.val(c).trigger("input")}})},o.addIPHandler=function(e){e.off("click",".chat-ip-button").on("click",".chat-ip-button",async function(t){t.stopPropagation();const a=$(this),c=a.find(".copy .copy-ip-text");let v=a.attr("data-ip");if(v){navigator.clipboard.writeText(v),c.translateText("[[global:copied]]"),setTimeout(()=>c.text(v),2e3);return}const D=a.parents("[data-mid]").attr("data-mid");({ip:v}=await A.get(`/chats/${ajaxify.data.roomId}/messages/${D}/ip`)),a.attr("data-ip",v),a.find(".show").addClass("hidden"),a.find(".copy").removeClass("hidden"),c.text(v)})},o.addCopyTextLinkHandler=function(e){function t(a,c){navigator.clipboard.writeText(c),a.find("i").addClass("fa-check").removeClass("fa-link"),setTimeout(()=>a.find("i").removeClass("fa-check").addClass("fa-link"),2e3)}e.off("click",'[data-action="copy-link"]').on("click",'[data-action="copy-link"]',function(a){a.stopPropagation();const c=$(this),v=c.attr("data-mid");v&&t(c,`${window.location.origin}/message/${v}`)}),e.off("click",'[data-action="copy-text"]').on("click",'[data-action="copy-text"]',function(a){a.stopPropagation();const c=$(this),v=c.parents("[data-mid]");v.length&&t(c,v.find('[component="chat/message/body"]').text().trim())})},o.addPopoutHandler=function(){$('[data-action="pop-out"]').on("click",function(){const e=x.get("chat/input").val(),t=ajaxify.data.roomId;app.previousUrl&&app.previousUrl.match(/chats/)?ajaxify.go("user/"+ajaxify.data.userslug+"/chats",function(){E.openChat(t,ajaxify.data.uid)},!0):(window.history.go(-1),E.openChat(t,ajaxify.data.uid)),$(window).one("action:chat.loaded",function(){x.get("chat/input").val(e)})})},o.addScrollHandler=function(e,t,a){let c=!1,v=a.scrollTop(),D=v;a.off("scroll").on("scroll",utils.debounce(function(){if(parseInt(a.attr("data-ignore-next-scroll"),10)===1){a.removeAttr("data-ignore-next-scroll"),v=a.scrollTop();return}if(n.toggleScrollUpAlert(a),c)return;D=a.scrollTop();const I=D>v?1:-1;v=D;const j=100*(D/(a[0].scrollHeight-a.height())),U=15,N=85;if(!(I===1&&!ajaxify.data.scrollToIndex)&&(j<U&&I===-1||j>N&&I===1)){c=!0;const F=a.children("[data-mid]").not(".new"),B=I>0?F.last():F.first(),M=parseInt(B.attr("data-index"),10)||0;A.get(`/chats/${e}/messages`,{uid:t,start:M,direction:I}).then(W=>{let R=W.messages;if(!R){c=!1;return}if(R=R.filter(function(H){const P=a.find('[component="chat/message"][data-mid="'+H.messageId+'"]');return P.removeClass("new"),!P.length}),!R.length){c=!1;return}n.parseMessage(R,function(H){if(a.attr("data-ignore-next-scroll",1),I>0)H.insertAfter(B),n.onMessagesAddedToDom(H);else{const P=a.scrollTop(),O=a[0].scrollHeight;a.prepend(H),n.onMessagesAddedToDom(H),a.scrollTop(a[0].scrollHeight-O+P)}c=!1})}).catch(g.error)}},100))},o.addScrollBottomHandler=function(e,t){t.parents('[component="chat/message/window"]').find('[component="chat/messages/scroll-up-alert"]').off("click").on("click",function(){ajaxify.data.scrollToIndex&&parseInt(ajaxify.data.roomId,10)===parseInt(e,10)?o.switchChat(e):n.scrollToBottom(t)})},o.addCharactersLeftHandler=function(e){e.find('[component="chat/input"]').on("change keyup paste",function(){n.updateRemainingLength(e)})},o.addTextareaResizeHandler=function(e){const t=e.find('[component="chat/input"]');t.on("input",function(){const a=e.find('[component="chat/message/content"]'),c=n.isAtBottom(a);t.css({height:0}),t.css({height:n.calcAutoTextAreaHeight(t)+"px"}),c&&n.scrollToBottom(a)})},o.addTypingHandler=function(e,t){const a=e.find('[component="chat/input"]');function c(I){A.put(`/chats/${t}/typing`,{typing:I}).catch(g.error)}a.on("focus",()=>a.val()&&c(!0)),a.on("blur",()=>c(!1));let v=0,D=!!a.val();a.on("input",function(){const I=!!a.val();I!==D?(clearTimeout(v),v=0,D=I,c(D)):v||(v=setTimeout(()=>{c(!!a.val()),v=0},5e3))})},o.addActionHandlers=function(e,t){e.on("click","[data-mid] [data-action]",function(){const a=$(this).parents("[data-mid]"),c=a.attr("data-mid"),v=this.getAttribute("data-action");switch($(this).tooltip("dispose"),v){case"reply":n.prepReplyTo(a,e);break;case"edit":n.prepEdit(a,c,t);break;case"delete":n.delete(c,t);break;case"restore":n.restore(c,t);break;case"pin":l.pin(c,t);break;case"unpin":l.unpin(c,t);break}})},o.addHotkeys=function(){y.bind("ctrl+up",function(){const t=$(".chats-list .active").prevAll("[data-roomid]").first();t.length&&t.attr("data-roomid")&&o.switchChat(t.attr("data-roomid"))}),y.bind("ctrl+down",function(){const t=$(".chats-list .active").nextAll("[data-roomid]").first();t.length&&t.attr("data-roomid")&&o.switchChat(t.attr("data-roomid"))}),y.bind("up",function(e){const t=x.get("chat/input");if(e.target===t.get(0)&&!t.val()){const a=x.get("chat/messages").find('.chat-message[data-self="1"]').last();if(!a.length)return;const c=a.attr("data-mid");n.prepEdit(a,c,ajaxify.data.roomId)}})},o.addManageHandler=function(e,t){h.init(e,t)},o.addLeaveHandler=function(e,t){t.on("click",function(){f.confirm({size:"small",title:"[[modules:chat.leave]]",message:'<p>[[modules:chat.leave-prompt]]</p><p class="form-text">[[modules:chat.leave-help]]</p>',callback:function(a){a&&A.del(`/chats/${e}/users/${app.user.uid}`,{}).then(()=>{const c=t.parents(".chat-modal");c.length?E.close(c):(o.destroyAutoComplete(e),ajaxify.go("chats"))}).catch(g.error)}})})},o.addDeleteHandler=function(e,t){t.on("click",function(){f.confirm({size:"small",title:"[[modules:chat.delete]]",message:"<p>[[modules:chat.delete-prompt]]</p>",callback:function(a){a&&A.del(`/admin/chats/${e}`,{}).then(()=>{const c=t.parents(".chat-modal");c.length?E.close(c):(o.destroyAutoComplete(e),ajaxify.go("chats"))}).catch(g.error)}})})},o.addRenameHandler=function(e,t){t.on("click",async function(){const{roomName:a}=await A.get(`/chats/${e}`),c=await app.parseAndTranslate("modals/rename-room",{name:a}),v=f.dialog({title:"[[modules:chat.rename-room]]",message:c,onEscape:!0,buttons:{save:{label:"[[global:save]]",className:"btn-primary",callback:function(){return A.put(`/chats/${e}`,{name:v.find("#roomName").val()}).then(()=>{v.modal("hide")}).catch(g.error),!1}}}})})},o.addSendHandlers=function(e,t,a){utils.isMobile()||t.off("keypress").on("keypress",function(c){if(c.which===13&&!c.shiftKey)return n.sendMessage(e,t),!1}),a.off("click").on("click",function(){return n.sendMessage(e,t),t.focus(),!1})},o.createAutoComplete=function(e,t,a={}){if(!t.length)return;const c={element:t,strategies:[],options:{style:{"z-index":2e4,flex:0,top:"inherit"},placement:"top",className:`chat-autocomplete-dropdown-${e} dropdown-menu textcomplete-dropdown`,...a}};if($(window).trigger("chat:autocomplete:init",c),c.strategies.length){const v=r.setup(c);return e&&(o.activeAutocomplete[e]=v),v}},o.destroyAutoComplete=function(e){o.activeAutocomplete[e]&&(o.activeAutocomplete[e].destroy(),delete o.activeAutocomplete[e])},o.leave=function(e){const t=e.attr("data-roomid");A.del(`/chats/${t}/users/${app.user.uid}`,{}).then(()=>{parseInt(t,10)===parseInt(ajaxify.data.roomId,10)?ajaxify.go("user/"+ajaxify.data.userslug+"/chats"):e.remove(),o.destroyAutoComplete(t);const a=E.getModal(t);a.length&&E.close(a)}).catch(g.error)},o.switchChat=function(e){e||(e=""),o.destroyAutoComplete(ajaxify.data.roomId),socket.emit("modules.chats.leave",ajaxify.data.roomId);const t="user/"+ajaxify.data.userslug+"/chats/"+e+window.location.search;if(!self.fetch)return ajaxify.go(t);const a=new URL(document.location).searchParams;a.set("switch",1);const c=`${config.relative_path}/api/user/${ajaxify.data.userslug}/chats/${e}?${a.toString()}`;fetch(c,{credentials:"include"}).then(async function(v){if(!v.ok)return console.warn("[search] Received "+v.status);const D=await v.json(),I=await app.parseAndTranslate("partials/chats/message-window",D),j=x.get("chat/main-wrapper");j.html(I),j.attr("data-roomid",e),T=$('[component="chat/nav-wrapper"]'),I.find(".timeago").timeago(),ajaxify.data={...ajaxify.data,...D,roomId:e},ajaxify.updateTitle(ajaxify.data.title),$("body").toggleClass("chat-loaded",!!e),j.find('[data-bs-toggle="tooltip"]').tooltip({trigger:"hover",container:"#content"}),o.setActive(e),o.addEventListeners(),u.fire("action:chat.loaded",$(".chats-full")),n.scrollToBottomAfterImageLoad(j.find('[component="chat/message/content"]')),history.pushState&&history.pushState({url:t},null,window.location.protocol+"//"+window.location.host+config.relative_path+"/"+t)}).catch(function(v){console.warn("[search] "+v.message)})},o.addGlobalEventListeners=function(){$(window).on("mousemove keypress click",function(){L&&ajaxify.data.roomId&&(A.del(`/chats/${ajaxify.data.roomId}/state`,{}),L=!1)})},o.addSocketListeners=function(){socket.on("event:new_notification",async function(t){const{type:a,roomId:c}=t;if(ajaxify.data.template.chats&&app.user.userslug&&(a==="new-chat"||a==="new-group-chat")){if(parseInt(c,10)===parseInt(ajaxify.data.roomId,10))return;const{rooms:D}=await A.get("/chats",{start:0,perPage:1}),I=D.find(j=>parseInt(j.roomId,10)===parseInt(c,10));if(I)if(T.find(`[data-roomid="${c}"]`).length)e(c,I.teaser);else{const U=x.get("chat/recent"),N=await app.parseAndTranslate("chats","rooms",{rooms:[I],showBottomHr:!0});U.prepend(N)}}}),socket.on("event:chats.receive",function(t){E.isFromBlockedUser(t.fromUid)||parseInt(t.roomId,10)===parseInt(ajaxify.data.roomId,10)&&(t.self=parseInt(app.user.uid,10)===parseInt(t.fromUid,10)?1:0,L||(L=t.self===0),t.message.self=t.self,t.message.timestamp=Math.min(Date.now(),t.message.timestamp),t.message.timestampISO=utils.toISOString(t.message.timestamp),n.appendChatMessage($('[component="chat/message/content"]'),t.message),e(t.roomId,{content:utils.stripHTMLTags(utils.decodeHTMLEntities(t.message.content)),user:t.message.fromUser,timestampISO:t.message.timestampISO}))});async function e(t,a){const c=$(`[data-roomid="${t}"]`);if(c.length){const v=await app.parseAndTranslate("partials/chats/room-teaser",{teaser:a});c.find('[component="chat/room/teaser"]').html(v[0].outerHTML),c.find(".timeago").timeago()}}socket.on("event:chats.public.unread",function(t){E.isFromBlockedUser(t.fromUid)||E.isLookingAtRoom(t.roomId)||app.user.uid===parseInt(t.fromUid,10)||(o.markChatPageElUnread(t),o.increasePublicRoomUnreadCount(T.find("[data-roomid="+t.roomId+"]")))}),socket.on("event:user_status_change",function(t){app.updateUserStatus($('.chats-list [data-uid="'+t.uid+'"] [component="user/status"]'),t.status)}),n.addSocketListeners(),socket.on("event:chats.roomRename",function(t){const a=x.get("chat/recent/room",t.roomId);if(a.length){const v=a.find('[component="chat/room/title"]');ajaxify.data.roomName=t.newName,v.translateText(t.newName?t.newName:ajaxify.data.usernames)}const c=$(`[component="chat/main-wrapper"][data-roomid="${t.roomId}"] [component="chat/header/title"]`);c.length&&c.html(t.newName?`<i class="fa ${ajaxify.data.icon} text-muted"></i> ${t.newName}`:ajaxify.data.chatWithMessage)}),socket.on("event:chats.mark",({roomId:t,state:a})=>{$(`[component="chat/recent"] [data-roomid="${t}"], [component="chat/list"] [data-roomid="${t}"], [component="chat/public"] [data-roomid="${t}"]`).each((v,D)=>{const I=$(D);E.markChatElUnread(I,a===1),a===0&&o.updatePublicRoomUnreadCount(I,0)})}),socket.on("event:chats.typing",async t=>{t.uid===app.user.uid||E.isFromBlockedUser(t.uid)||E.updateTypingUserList($(`[component="chat/main-wrapper"][data-roomid="${t.roomId}"]`),t)})},o.markChatPageElUnread=function(e){if(!ajaxify.data.template.chats)return;const t=T.find("[data-roomid="+e.roomId+"]");E.markChatElUnread(t,!0)},o.increasePublicRoomUnreadCount=function(e){const t=e.find('[component="chat/public/room/unread/count"]'),a=(parseInt(t.attr("data-count"),10)||0)+1;o.updatePublicRoomUnreadCount(e,a)},o.updatePublicRoomUnreadCount=function(e,t){const a=e.find('[component="chat/public/room/unread/count"]'),c=t>50?"50+":t;a.toggleClass("hidden",t<=0).text(c).attr("data-count",t)},o.setActive=function(e){if(T.find("[data-roomid]").removeClass("active"),e){socket.emit("modules.chats.enter",e);const t=T.find(`[data-roomid="${e}"]`);t.addClass("active"),t.hasClass("unread")&&(A.del(`/chats/${e}/state`,{}),t.removeClass("unread")),utils.isMobile()||$('.expanded-chat [component="chat/input"]').focus(),n.updateTextAreaHeight($(`[component="chat/messages"][data-roomid="${e}"]`))}T.attr("data-loaded",e?"1":"0")},o}.apply(k,w),C!==void 0&&(b.exports=C)},43103:(b,k,m)=>{"use strict";var w,C;w=[m(29930)],C=function(x){const y={};return y.init=function(d){const p=d.uploadFormEl;if(p.length&&(p.attr("action",config.relative_path+d.route),d.dragDropAreaEl&&y.handleDragDrop({container:d.dragDropAreaEl,callback:function(h){y.ajaxSubmit({uploadForm:p,upload:h,callback:d.callback})}}),d.pasteEl&&y.handlePaste({container:d.pasteEl,callback:function(h){y.ajaxSubmit({uploadForm:p,upload:h,callback:d.callback})}}),d.uploadBtnEl)){const h=p.find('input[name="files[]"]');d.uploadBtnEl.on("click",function(){h.trigger("click")}),h.on("change",function(n){const s=(n.target||{}).files||($(this).val()?[{name:$(this).val(),type:utils.fileMimeType($(this).val())}]:null);s&&y.ajaxSubmit({uploadForm:p,upload:{files:s,fileNames:Array.from(s).map(i=>i.name)},callback:d.callback})})}},y.handleDragDrop=function(d){let p=!1;const h=d.container,n=d.container.find(".imagedrop");h.on("dragenter",function(){p||(n.css("top","0px"),n.css("height",h.height()+"px"),n.css("line-height",h.height()+"px"),n.show(),n.on("dragleave",function(){n.hide(),n.off("dragleave")}))}),n.on("drop",function(l){l.preventDefault();const r=l.originalEvent.dataTransfer.files;if(r.length){let f;if(window.FormData){f=new FormData;for(var u=0;u<r.length;++u)f.append("files[]",r[u],r[u].name)}d.callback({files:r,formData:f})}return n.hide(),!1});function s(i){return i.preventDefault(),!1}$(document).off("dragstart").on("dragstart",function(){p=!0}).off("dragend").on("dragend, mouseup",function(){p=!1}),n.on("dragover",s),n.on("dragenter",s)},y.handlePaste=function(d){d.container.on("paste",function(h){const n=(h.clipboardData||h.originalEvent.clipboardData||{}).items,s=[],i=[];let l=null;window.FormData&&(l=new FormData),[].forEach.call(n,function(r){const u=r.getAsFile();if(u){const f=utils.generateUUID()+"-"+u.name;l&&l.append("files[]",u,f),s.push(u),i.push(f)}}),s.length&&d.callback({files:s,fileNames:i,formData:l})})},y.ajaxSubmit=function(d){const p=[...d.upload.files];for(let n=0;n<p.length;++n){const s=p[n].type.match(/image./);if(s&&!app.user.privileges["upload:post:image"]||!s&&!app.user.privileges["upload:post:file"])return x.error("[[error:no-privileges]]");if(!app.user.isAdmin&&p[n].size>parseInt(config.maximumFileSize,10)*1024)return d.uploadForm[0].reset(),x.error("[[error:file-too-big, "+config.maximumFileSize+"]]")}const h=Date.now();d.uploadForm.off("submit").on("submit",function(){return $(this).ajaxSubmit({headers:{"x-csrf-token":config.csrf_token},resetForm:!0,clearForm:!0,formData:d.upload.formData,error:function(n){let s=n.responseJSON&&(n.responseJSON.error||n.responseJSON.status&&n.responseJSON.status.message)||"[[error:parse-error]]";n&&n.status===413&&(s=n.statusText||"Request Entity Too Large"),x.error(s),x.remove(h)},uploadProgress:function(n,s,i,l){x.alert({alert_id:h,message:"[[modules:composer.uploading, "+l+"%]]"})},success:function(n){const s=n.response.images;if(s&&s.length)for(var i=0;i<s.length;++i)s[i].filename=p[i].name,s[i].isImage=/image./.test(p[i].type);d.callback(s)},complete:function(){d.uploadForm[0].reset(),setTimeout(x.remove,100,h)}}),!1}),d.uploadForm.submit()},y}.apply(k,w),C!==void 0&&(b.exports=C)},53309:(b,k,m)=>{"use strict";var w,C;w=[m(52473),m(49897),m(29930)],C=function(x,y,d){const p={};let h=[];p.init=function(r){r=r||{},h.length=0,x.get("chat/search").on("keyup",utils.debounce(s,250));const u=$('[component="chat/search/list"]');u.on("click","[data-uid]",function(){r.onSelect&&r.onSelect(h.find(f=>parseInt(f.uid,10)===parseInt($(this).attr("data-uid"),10))),n(u)})};function n(r){x.get("chat/search").val(""),i(r),r.find('[component="chat/search/no-users"]').addClass("hidden"),r.find('[component="chat/search/start-typing"]').removeClass("hidden")}function s(){const r=$('[component="chat/search/list"]'),u=x.get("chat/search").val();if(!u)return n(r);r.find('[component="chat/search/start-typing"]').addClass("hidden"),y.get("/api/users",{query:u,searchBy:"username",paginate:!1}).then(l).catch(d.error)}function i(r){h.length=0,r.find("[data-uid]").remove()}async function l(r){const u=$('[component="chat/search/list"]');if(i(u),r.users=r.users.filter(function(g){return parseInt(g.uid,10)!==parseInt(app.user.uid,10)}),h=r.users,!r.users.length)return u.find('[component="chat/search/no-users"]').removeClass("hidden");u.find('[component="chat/search/no-users"]').addClass("hidden");const f=await app.parseAndTranslate("modals/create-room","searchUsers",{searchUsers:r.users});u.append(f),u.parent().toggleClass("show",!0)}return p}.apply(k,w),C!==void 0&&(b.exports=C)},58836:(b,k,m)=>{"use strict";var w,C;w=[m(49897),m(29930),m(17459),m(34405),m(72513)],C=function(x,y,d,p,h){const n={};n.init=function(r,u){let f;u.on("click",async function(){let g=[];app.user.isAdmin&&({groups:g}=await x.get("/admin/groups"),g.sort((T,e)=>e.system-T.system).map(T=>{const{name:e,displayName:t}=T;return{name:e,displayName:t}}),Array.isArray(ajaxify.data.groups)&&g.forEach(T=>{T.selected=ajaxify.data.groups.includes(T.name)}));const E=await app.parseAndTranslate("modals/manage-room",{groups:g,user:app.user,room:ajaxify.data});f=bootbox.dialog({title:"[[modules:chat.manage-room]]",size:"large",message:E,onEscape:!0}),f.attr("component","chat/manage-modal"),l(r,f),s(r,f),i(r,f);const A=f.find('[component="chat/manage/user/list"]'),S=f.find('[component="chat/manage/user/list/search"]');h.addSearchHandler(r,S,async T=>{S.val()?A.html(await app.parseAndTranslate("partials/chats/manage-room-users",T)):l(r,f)}),h.addInfiniteScrollHandler(r,A,async(T,e)=>{T.append(await app.parseAndTranslate("partials/chats/manage-room-users",e))});const o=f.find('[component="chat/manage/user/add/search"]'),L=f.find(".text-danger");p.user(o,function(T,e){L.text(""),x.post(`/chats/${r}/users`,{uids:[e.item.user.uid]}).then(t=>{l(r,f,t),o.val("")}).catch(t=>{d.translate(t.message,function(a){L.text(a)})})}),f.find('[component="chat/manage/save"]').on("click",()=>{const T=f.find('[component="chat/room/notification/setting"]');x.put(`/chats/${r}`,{groups:f.find('[component="chat/room/groups"]').val(),notificationSetting:T.val()}).then(e=>{ajaxify.data.groups=e.groups,ajaxify.data.notificationSetting=e.notificationSetting;const t=e.notificationOptions[0];$('[component="chat/notification/setting"] [data-icon]').first().attr("data-icon",t.icon),$('[component="chat/notification/setting/sub-label"]').translateText(t.subLabel),t.selected&&$('[component="chat/notification/setting/icon"]').attr("class",`fa ${t.icon}`),f.modal("hide")}).catch(y.error)})})};function s(r,u){u.on("click",'[data-action="kick"]',function(){const f=parseInt(this.getAttribute("data-uid"),10);x.del(`/chats/${r}/users/${f}`,{}).then(g=>{l(r,u,g)}).catch(y.error)})}function i(r,u){u.on("click",'[data-action="toggleOwner"]',async function(){const f=parseInt(this.getAttribute("data-uid"),10),g=u.get(0).querySelector(`[component="chat/manage/user/list"] > [data-uid="${f}"] [component="chat/manage/user/owner/icon"]`),E=!g.classList.contains("hidden");await x[E?"del":"put"](`/chats/${r}/owners/${f}`),g.classList.toggle("hidden")})}async function l(r,u,f){const g=u.find('[component="chat/manage/user/list"]');if(!f)try{f=await x.get(`/chats/${r}/users`,{})}catch{g.find("li").text(await d.translate("[[error:invalid-data]]"))}g.find('[data-bs-toggle="tooltip"]').tooltip("dispose"),g.html(await app.parseAndTranslate("partials/chats/manage-room-users",f)),g.find('[data-bs-toggle="tooltip"]').tooltip()}return n}.apply(k,w),C!==void 0&&(b.exports=C)},62590:(b,k,m)=>{"use strict";var w,C;w=[m(91749)],C=function(x){var y={};return y.render=function(d,p){if(p=p||function(){},!d.find(".preview-container").is(":visible"))return p();var h=d.find("textarea");socket.emit("plugins.composer.renderPreview",h.val(),function(n,s){n||(s=$("<div>"+s+"</div>"),s.find("img:not(.not-responsive)").addClass("img-fluid"),d.find(".preview").html(s),x.fire("action:composer.preview",{postContainer:d,preview:s}),p())})},y.matchScroll=function(d){if(d.find(".preview-container").is(":visible")){var p=d.find("textarea"),h=d.find(".preview");if(p.length&&h.length){var n=p[0].scrollHeight-p.height();if(n===0)return;var s=p.scrollTop()/n;h.scrollTop(Math.max(h[0].scrollHeight-h.height(),0)*s)}}},y.handleToggler=function(d){const p=d.get(0);y.env=utils.findBootstrapEnvironment();const h=["xs","sm"].includes(y.env),n=p.querySelector('.formatting-bar [data-action="preview"]'),s=n.querySelector(".show-text"),i=n.querySelector(".hide-text"),l=localStorage.getItem("composer:previewToggled"),r=config["composer-default"].hidePreviewOnOpen==="on";let u=!h&&(l===null&&!r||l==="true");const f=p.querySelector(".preview-container"),g=p.querySelector(".write-container");if(!n)return;function E(A){h?(f.classList.toggle("hide",!1),g.classList.toggle("maximized",!1),f.classList.toggle("d-none",!A),f.classList.toggle("d-flex",A),f.classList.toggle("w-100",A),g.classList.toggle("d-flex",!A),g.classList.toggle("d-none",A),g.classList.toggle("w-100",!A)):(f.classList.toggle("hide",!A),g.classList.toggle("w-50",A),g.classList.toggle("w-100",!A),localStorage.setItem("composer:previewToggled",A)),s.classList.toggle("hide",A),i.classList.toggle("hide",!A),A&&y.render(d),y.matchScroll(d)}y.toggle=E,n.addEventListener("click",A=>{A.button===0&&(u=!u,E(u))}),E(u)},y}.apply(k,w),C!==void 0&&(b.exports=C)},65161:(b,k,m)=>{"use strict";var w,C;w=[m(52473),m(29930),m(60419)],C=function(x,y,d){const p={};let h=0,n,s,i,l,r,u;p.init=function(S,o){h=S,s=o.find('[component="chat/message/search/results"]'),i=o.find('[component="chat/message/content"]'),l=o.find('[component="chat/room/search/clear"]'),u=o.find('[component="chat/room/search/container"]'),r=o.find('[component="chat/room/search/toggle"'),n=o.find('[component="chat/room/search"]'),n.on("keyup",utils.debounce(g,250)).on("focus",()=>{n.val()&&g()}),o.find('[component="chat/input"]').on("focus",()=>{s.addClass("hidden"),i.removeClass("hidden")}),l.on("click",f),r.on("click",()=>{u.removeClass("hidden"),r.addClass("hidden"),n.trigger("focus")}),n.on("blur",()=>{n.val()||f()})};function f(){n.val(""),E(),s.addClass("hidden"),l.addClass("hidden"),u.addClass("hidden"),i.removeClass("hidden"),r.removeClass("hidden")}async function g(){const S=n.val();!S||S.length<=2||(l.removeClass("hidden"),socket.emit("modules.chats.searchMessages",{content:S,roomId:h}).then(A).catch(y.error))}function E(){s.children("[data-mid]").remove()}async function A(S){if(E(),!S.messages.length)return s.removeClass("hidden"),i.addClass("hidden"),s.find('[component="chat/message/search/no-results"]').removeClass("hidden");s.find('[component="chat/message/search/no-results"]').addClass("hidden");const o=await app.parseAndTranslate("partials/chats/messages",{messages:S.messages,isAdminOrGlobalMod:app.user.isAdmin||app.user.isGlobalMod});s.append(o),d.onMessagesAddedToDom(s.find('[component="chat/message"]')),i.addClass("hidden"),s.removeClass("hidden")}return p}.apply(k,w),C!==void 0&&(b.exports=C)},72513:(b,k,m)=>{"use strict";var w,C;w=[m(49897)],C=function(x){const y={};let d=0;y.init=function(s,i){const l=i.find('[component="chat/user/list"]');if(!l.length)return;const r=i.find('[component="chat/messages/pinned/container"]');i.find('[component="chat/user/list/btn"]').on("click",()=>{l.toggleClass("hidden"),l.hasClass("hidden")?h():(r.addClass("hidden"),p(s,l))}),$(window).off("action:ajaxify.start",h).one("action:ajaxify.start",h),y.addInfiniteScrollHandler(s,l,async(u,f)=>{u.append(await app.parseAndTranslate("partials/chats/user-list","users",f))})};function p(s,i){d&&clearInterval(d),d=setInterval(()=>{n(s,i)},5e3)}function h(){d&&(clearInterval(d),d=0)}async function n(s,i){if(ajaxify.data.template.chats&&app.isFocused&&i.scrollTop()===0&&!i.hasClass("hidden")){const l=await x.get(`/chats/${s}/users`,{start:0});i.find('[data-bs-toggle="tooltip"]').tooltip("dispose"),i.html(await app.parseAndTranslate("partials/chats/user-list","users",l)),i.find('[data-bs-toggle="tooltip"]').tooltip()}}return y.addInfiniteScrollHandler=function(s,i,l){i.on("scroll",utils.debounce(async()=>{const r=(i[0].scrollHeight-i.height())*.85;if(i.scrollTop()>r){const u=i.find("[data-index]").last().attr("data-index"),f=await x.get(`/chats/${s}/users`,{start:parseInt(u,10)+1});f&&f.users.length&&l(i,f)}},200))},y.addSearchHandler=function(s,i,l){i.on("keyup",utils.debounce(async()=>{const r=i.val(),u=await x.get(`/search/chats/${s}/users`,{query:r});l(u)},200))},y}.apply(k,w),C!==void 0&&(b.exports=C)},80083:(b,k,m)=>{"use strict";var w,C;w=[m(52473),m(49897),m(29930),m(53309)],C=function(x,y,d,p){const h={};h.init=function(){x.get("chat/create").on("click",n)};async function n(){let s=[];app.user.isAdmin&&({groups:s}=await y.get("/admin/groups"),s.sort((u,f)=>f.system-u.system).map(u=>{const{name:f,displayName:g}=u;return{name:f,displayName:g}}));const i=await app.parseAndTranslate("modals/create-room",{user:app.user,groups:s}),l=bootbox.dialog({title:"[[modules:chat.create-room]]",message:i,onEscape:!0,buttons:{save:{label:"[[global:create]]",className:"btn-primary",callback:function(){const u=l.find('[component="chat/room/name"]').val(),f=l.find('[component="chat/room/users"] [component="chat/user"]').find("[data-uid]").map((A,S)=>$(S).attr("data-uid")).get(),g=l.find('[component="chat/room/type"]').val(),E=l.find('[component="chat/room/groups"]').val();return g==="private"&&!f.length?(d.error("[[error:no-users-selected]]"),!1):g==="public"&&!E.length?(d.error("[[error:no-groups-selected]]"),!1):app.user.uid?(y.post("/chats",{roomName:u,uids:f,type:g,groups:E}).then(({roomId:A})=>{ajaxify.go("chats/"+A),l.modal("hide")}).catch(d.error),!1):(d.error("[[error:not-logged-in]]"),!1)}}}}),r=l.find('[component="chat/room/users"]');p.init({onSelect:async function(u){const f=await app.parseAndTranslate("modals/create-room","selectedUsers",{selectedUsers:[u]});r.append(f)}}),r.on("click",'[component="chat/room/users/remove"]',function(){$(this).parents("[data-uid]").remove()}),l.find('[component="chat/room/type"]').on("change",function(){const u=$(this).val();l.find('[component="chat/room/public/options"]').toggleClass("hidden",u==="private")})}return h}.apply(k,w),C!==void 0&&(b.exports=C)},88518:(b,k,m)=>{b.exports=m(54516)},89596:(b,k,m)=>{b.exports=m(62590)},93230:(b,k,m)=>{"use strict";var w,C;w=[m(49897),m(29930)],C=function(x,y){const d={};let p;d.init=function(i){p=i,$('[component="chat/pinned/messages/btn"]').on("click",async()=>{const l=p.find('[component="chat/messages/pinned/container"]');if(!l.hasClass("hidden"))return l.addClass("hidden");p.find('[component="chat/user/list"]').addClass("hidden"),await d.refreshList(),l.removeClass("hidden")}),h(p)};function h(i){const l=i.find('[component="chat/messages/pinned"]');l.on("scroll",utils.debounce(async()=>{const r=(l[0].scrollHeight-l.height())*.85;if(l.scrollTop()>r){const u=l.find("[data-index]").last().attr("data-index"),f=await s(parseInt(u,10)+1);if(f&&f.length){const g=await n(f);i.find('[component="chat/messages/pinned"]').append(g)}}},200))}d.refreshList=async function(){const i=await s(0);if(!i.length){p.find('[component="chat/messages/pinned/empty"]').removeClass("hidden"),p.find('[component="chat/messages/pinned"]').html("");return}p.find('[component="chat/messages/pinned/empty"]').addClass("hidden");const l=await n(i);p.find('[component="chat/messages/pinned"]').html(l),l.find(".timeago").timeago()};async function n(i){return await app.parseAndTranslate("partials/chats/pinned-messages-list","messages",{isOwner:ajaxify.data.isOwner,isAdminOrGlobalMod:ajaxify.data.isAdminOrGlobalMod,messages:i})}async function s(i){const{messages:l}=await x.get(`/chats/${ajaxify.data.roomId}/messages/pinned`,{start:i});return l}return d.pin=function(i,l){x.put(`/chats/${l}/messages/${i}/pin`,{}).then(()=>{$(`[component="chat/message"][data-mid="${i}"]`).toggleClass("pinned",!0),d.refreshList()}).catch(y.error)},d.unpin=function(i,l){x.del(`/chats/${l}/messages/${i}/pin`,{}).then(()=>{$(`[component="chat/message"][data-mid="${i}"]`).toggleClass("pinned",!1),p.find(`[component="chat/messages/pinned"] [data-mid="${i}"]`).remove(),p.find('[component="chat/messages/pinned"] [data-mid]').length||p.find('[component="chat/messages/pinned/empty"]').removeClass("hidden")}).catch(y.error)},d}.apply(k,w),C!==void 0&&(b.exports=C)}}]);
