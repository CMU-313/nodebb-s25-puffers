"use strict";(self.webpackChunknodebb=self.webpackChunknodebb||[]).push([[11295,49047,99127,34271,13417,69185,86198,1091,49897,34405],{63431:(D,T,m)=>{var P,v;P=[m(49897),m(34405),m(40027),m(29930),m(17459),m(65348),m(6411),m(2627),m(54222)],v=function(x,k,C,p,f,a,c,g,d){const n={};let l;n.init=function(){l=isNaN(parseInt(ajaxify.data.selectedCategory.cid,10))?"admin":ajaxify.data.selectedCategory.cid,g.init(".privilege-table-container"),a.init($('[component="category-selector"]'),{onSelect:function(t){l=parseInt(t.cid,10),l=isNaN(l)?"admin":l,n.refreshPrivilegeTable(),ajaxify.updateHistory("admin/manage/privileges/"+(l||""))},localCategories:ajaxify.data.categories,privilege:"find",showLinks:!0}),n.setupPrivilegeTable(),L(),$(".privilege-filters button:first-child").click()},n.setupPrivilegeTable=function(){$(".privilege-table-container").on("change",'input[type="checkbox"]:not(.checkbox-helper)',function(){const t=this,e=$(this),i=e.parents("[data-privilege]"),o=i.index()+1,h=i.attr("data-privilege"),y=e.prop("checked"),b=e.parents("tr"),S=b.attr("data-group-name")||b.attr("data-uid"),j=parseInt(b.attr("data-private")||0,10),F=b.attr("data-group-name")!==void 0,R=F&&b.attr("data-group-name")==="banned-users"||b.attr("data-banned")!==void 0?"banned-users":"registered-users",I=e.prop("checked")===(i.attr("data-value")==="true")?null:y;S?(F&&h==="groups:moderate"&&!j&&y?C.confirm("[[admin/manage/privileges:alert.confirm-moderate]]",function(B){B?(i.attr("data-delta",I),n.applyDeltaState(t,I),n.exposeSingleAssumedPriv(o,R)):e.prop("checked",!e.prop("checked"))}):h.endsWith("admin:admins-mods")&&y?C.confirm("[[admin/manage/privileges:alert.confirm-admins-mods]]",function(B){B?(i.attr("data-delta",I),n.applyDeltaState(t,I),n.exposeSingleAssumedPriv(o,R)):e.prop("checked",!e.prop("checked"))}):(i.attr("data-delta",I),n.applyDeltaState(t,I),n.exposeSingleAssumedPriv(o,R)),g.updateState(e)):p.error("[[error:invalid-data]]")}),n.exposeAssumedPrivileges(),g.updateAll(),n.addEvents()},n.applyDeltaState=(t,e)=>{["bg-success","bg-opacity-75","border-success"].forEach(i=>{t.classList.toggle(i,e===!0)}),["bg-danger","bg-opacity-50","border-danger"].forEach(i=>{t.classList.toggle(i,e===!1)})},n.addEvents=function(){document.getElementById("save").addEventListener("click",function(){i("save",n.commit)}),document.getElementById("discard").addEventListener("click",function(){i("discard",n.discard)});const t=document.querySelector(".privilege-table-container");t.addEventListener("change",o=>{o.target.closest("td[data-privilege] input")&&(document.getElementById("discard").style.display=t.querySelectorAll("td[data-delta]").length?"unset":"none")});const e=$(".privilege-table-container");e.on("click",'[data-action="search.user"]',n.addUserToPrivilegeTable),e.on("click",'[data-action="search.group"]',n.addGroupToPrivilegeTable),e.on("click",'[data-action="copyToChildren"]',function(){i("copyToChildren",n.copyPrivilegesToChildren.bind(null,l,""))}),e.on("click",'[data-action="copyToChildrenGroup"]',function(){const o=$(this).parents("[data-group-name]").attr("data-group-name");i("copyToChildrenGroup",n.copyPrivilegesToChildren.bind(null,l,o))}),e.on("click",'[data-action="copyPrivilegesFrom"]',function(){n.copyPrivilegesFromCategory(l,"")}),e.on("click",'[data-action="copyPrivilegesFromGroup"]',function(){const o=$(this).parents("[data-group-name]").attr("data-group-name");n.copyPrivilegesFromCategory(l,o)}),e.on("click",'[data-action="copyToAll"]',function(){i("copyToAll",n.copyPrivilegesToAllCategories.bind(null,l,""))}),e.on("click",'[data-action="copyToAllGroup"]',function(){const o=$(this).parents("[data-group-name]").attr("data-group-name");i("copyToAllGroup",n.copyPrivilegesToAllCategories.bind(null,l,o))}),e.on("click",".privilege-filters button",W),c.bind("ctrl+s",function(o){i("save",n.commit),o.preventDefault()});function i(o,h){const y=U();C.confirm(`[[admin/manage/privileges:alert.confirm-${o}, ${y}]]<br /><br />[[admin/manage/privileges:alert.no-undo]]`,function(b){b&&h.call()})}},n.commit=function(){const t=document.querySelector(".privilege-table-container"),e=$.map(t.querySelectorAll("td[data-delta]"),function(i){const o=i.getAttribute("data-privilege"),h=i.parentNode,y=h.getAttribute("data-group-name")||h.getAttribute("data-uid"),b=i.getAttribute("data-delta")==="true"?1:0;return n.setPrivilege(y,o,b)});Promise.allSettled(e).then(i=>{n.refreshPrivilegeTable();const o=i.filter(h=>h.status==="rejected");o.length?o.forEach(h=>{p.error(h.reason)}):d.toggleSaveSuccess($("#save"))})},n.discard=function(){n.refreshPrivilegeTable(),p.success("[[admin/manage/privileges:alert.discarded]]")},n.refreshPrivilegeTable=function(t){x.get(`/categories/${l}/privileges`,{}).then(e=>{ajaxify.data.privileges={...ajaxify.data.privileges,...e};const i=parseInt(l,10)?"admin/partials/privileges/category":"admin/partials/privileges/global",o=ajaxify.currentPage.endsWith("admin/manage/privileges/admin");app.parseAndTranslate(i,{privileges:e,isAdminPriv:o}).then(h=>{const y=$(".privilege-filters button.btn-warning").map((b,S)=>$(S).index()).get();$(".privilege-table-container").html(h),n.exposeAssumedPrivileges(),document.querySelectorAll(".privilege-filters").forEach((b,S)=>{const j=y[S]===void 0?0:y[S];b.querySelectorAll("button")[j].click()}),A("data-group-name",t)})}).catch(alert.error)},n.exposeAssumedPrivileges=function(){const t=(h,y)=>`.privilege-table tr[data-banned] td[data-privilege="${h[y]}"] input`,e=s("banned-users");r(e,t);const i=(h,y)=>`.privilege-table tr[data-group-name]:not([data-group-name="registered-users"],[data-group-name="banned-users"],[data-group-name="guests"],[data-group-name="spiders"]) td[data-privilege="${h[y]}"] input, .privilege-table tr[data-uid]:not([data-banned]) td[data-privilege="${h[y]}"] input`,o=s("registered-users");r(o,i)},n.exposeSingleAssumedPriv=function(t,e){let i;switch(e){case"banned-users":i=()=>`.privilege-table tr[data-banned] td[data-privilege]:nth-child(${t}) input`;break;default:i=()=>`.privilege-table tr[data-group-name]:not([data-group-name="registered-users"],[data-group-name="banned-users"],[data-group-name="guests"],[data-group-name="spiders"]) td[data-privilege]:nth-child(${t}) input, .privilege-table tr[data-uid]:not([data-banned]) td[data-privilege]:nth-child(${t}) input`}const o=u(e,t);E(i,o)},n.setPrivilege=(t,e,i)=>x[i?"put":"del"](`/categories/${isNaN(l)?0:l}/privileges/${encodeURIComponent(e)}`,{member:t}),n.addUserToPrivilegeTable=function(){const t=C.dialog({title:"[[admin/manage/categories:alert.find-user]]",message:'<input class="form-control input-lg" placeholder="[[admin/manage/categories:alert.user-search]]" />',show:!0});t.on("shown.bs.modal",function(){const e=t.find("input");e.focus(),k.user(e,function(i,o){O(o.item.user,function(){t.modal("hide")})})})},n.addGroupToPrivilegeTable=function(){const t=C.dialog({title:"[[admin/manage/categories:alert.find-group]]",message:'<input class="form-control input-lg" placeholder="[[admin/manage/categories:alert.group-search]]" />',show:!0});t.on("shown.bs.modal",function(){const e=t.find("input");e.focus(),k.group(e,function(i,o){if(o.item.group.name==="administrators")return p.alert({type:"warning",message:"[[admin/manage/privileges:alert.admin-warning]]"});w(o.item.group.name,function(){t.modal("hide")})})})},n.copyPrivilegesToChildren=function(t,e){const i=N();socket.emit("admin.categories.copyPrivilegesToChildren",{cid:t,group:e,filter:i},function(o){if(o)return p.error(o.message);p.success("[[admin/manage/categories:privileges.copy-success]]")})},n.copyPrivilegesFromCategory=function(t,e){const i=U(),o="<br>"+(e?`[[admin/manage/privileges:alert.copyPrivilegesFromGroup-warning, ${i}]]`:`[[admin/manage/privileges:alert.copyPrivilegesFrom-warning, ${i}]]`)+"<br><br>[[admin/manage/privileges:alert.no-undo]]";a.modal({title:"[[admin/manage/privileges:alert.copyPrivilegesFrom-title]]",message:o,localCategories:[],showLinks:!0,onSubmit:function(h){socket.emit("admin.categories.copyPrivilegesFrom",{toCid:t,filter:N(),fromCid:h.cid,group:e},function(y){if(y)return p.error(y);ajaxify.refresh()})}})},n.copyPrivilegesToAllCategories=function(t,e){const i=N();socket.emit("admin.categories.copyPrivilegesToAllCategories",{cid:t,group:e,filter:i},function(o){if(o)return p.error(o);p.success("[[admin/manage/categories:privileges.copy-success]]")})};function s(t){const e=[];return $(`.privilege-table tr[data-group-name="${t}"] td input[type="checkbox"]:not(.checkbox-helper)`).parents("[data-privilege]").each(function(i,o){$(o).find("input").prop("checked")&&e.push(o.getAttribute("data-privilege"))}),e.concat(e.map(function(i){return i.startsWith("groups:")?i.slice(7):!1})).filter(Boolean)}function u(t,e){return $(`.privilege-table tr[data-group-name="${t}"] td:nth-child(${e}) input[type="checkbox"]`)[0].checked}function r(t,e){for(let i=0,o=t.length;i<o;i+=1)$(e(t,i)).each(function(y,b){b.checked||(b.indeterminate=!0)})}function E(t,e){$(t()).each((o,h)=>{h.indeterminate=h.checked?!1:e})}function A(t,e){if(e){const i=$("["+t+"]").filter(function(){return $(this).attr(t)===String(e)});if(i.length)return i.addClass("selected"),!0}return!1}function L(){if(ajaxify.data.group){if(A("data-group-name",ajaxify.data.group))return;w(ajaxify.data.group)}}function w(t,e){if(e=e||function(){},document.querySelector('.privilege-table [data-group-name="'+t+'"]'))return A("data-group-name",t),e();const o={},h=ajaxify.data.privileges.keys.groups.reduce(function(y,b,S){return y[b]=!1,o[b]=ajaxify.data.privileges.labelData[S].type,y},{});app.parseAndTranslate("admin/partials/privileges/"+(isNaN(l)||l===0?"global":"category"),"privileges.groups",{privileges:{groups:[{name:t,nameEscaped:f.escape(t),privileges:h,types:o}]}},function(y){const b=document.querySelector(".privilege-table tbody"),S=$(".privilege-filters").first().find("button.btn-warning").index();b.append(y.get(0)),n.exposeAssumedPrivileges(),A("data-group-name",t),S>=0&&document.querySelector(".privilege-filters").querySelectorAll("button")[S].click(),e()})}async function O(t,e){if(e=e||function(){},document.querySelector('.privilege-table [data-uid="'+t.uid+'"]'))return A("data-uid",t.uid),e();const o={},h=ajaxify.data.privileges.keys.users.reduce(function(j,F,M){return j[F]=!1,o[F]=ajaxify.data.privileges.labelData[M].type,j},{}),y=await app.parseAndTranslate("admin/partials/privileges/"+(isNaN(l)?"global":"category"),"privileges.users",{privileges:{users:[{picture:t.picture,username:t.username,banned:t.banned,uid:t.uid,"icon:text":t["icon:text"],"icon:bgColor":t["icon:bgColor"],privileges:h,types:o}]}}),b=document.querySelectorAll(".privilege-table tbody"),S=$(".privilege-filters").last().find("button.btn-warning").index();b[1].append(y.get(0)),n.exposeAssumedPrivileges(),A("data-uid",t.uid),S>=0&&document.querySelectorAll(".privilege-filters")[1].querySelectorAll("button")[S].click(),e()}function W(t){const e=$(t.target),i=e.attr("data-filter");e.closest("table").find("thead tr:last-child, tbody tr").each((h,y)=>{$(y).find("[data-type]").addClass("hidden"),$(y).find(`[data-type="${i}"]`).removeClass("hidden")}),g.updateAll(),e.siblings("button").removeClass("btn-warning"),e.addClass("btn-warning")}function N(){return $('[component="privileges/groups/filters"] .btn-warning').attr("data-filter")}function U(){const t=document.querySelector(".privilege-filters .btn-warning"),e=t?t.textContent.toLocaleLowerCase():"";return e.indexOf("privileges")>-1?e:`${e} privileges`.trim()}return n}.apply(T,P),v!==void 0&&(D.exports=v)},2627:(D,T,m)=>{var P;P=function(){const v={};let x;v.toggling=!1,v.init=function(p){x=$(p),x.on("change","input.checkbox-helper",k)},v.updateAll=function(){x.find("input.checkbox-helper").each((p,f)=>{v.updateState($(f))})},v.updateState=function(p){if(v.toggling)return;const f=p.closest("tr").find("input:not([disabled]):visible").toArray(),a=$(f.shift()),c=f.length&&f.every(g=>g.checked);a.prop("checked",c)};function k(p){const f=$(p.target);C(f)}function C(p){v.toggling=!0;const f=p.prop("checked");p.closest("tr").find("input:not(.checkbox-helper):visible").each((a,c)=>{const g=$(c);g.prop("checked")!==f&&g.click()}),v.toggling=!1}return v}.call(T,m,T,D),P!==void 0&&(D.exports=P)},49897:(D,T,m)=>{m.r(T),m.d(T,{del:()=>l,get:()=>a,head:()=>c,patch:()=>d,post:()=>g,put:()=>n});var P=m(91749),v=m.n(P),x=m(40027),k=m.n(x);const C=config.relative_path+"/api/v3";async function p(s,u){if(s.url=s.url.startsWith("/api")?config.relative_path+s.url:C+s.url,typeof u=="function"){f(s).then(r=>u(null,r),r=>u(r));return}try{return await f(s)}catch(r){if(r.message==="A valid login session was not found. Please log in and try again."){const{url:E}=await(0,P.fire)("filter:admin.reauth",{url:"login"});return(0,x.confirm)("[[error:api.reauth-required]]",A=>{A&&ajaxify.go(E)})}throw r}}async function f(s){const{url:u}=s;delete s.url,s.data&&!(s.data instanceof FormData)&&(s.data=JSON.stringify(s.data||{}),s.headers["content-type"]="application/json; charset=utf-8"),{options:s}=await(0,P.fire)("filter:api.options",{options:s}),s.data&&(s.body=s.data,delete s.data);const r=await fetch(u,s),{headers:E}=r,A=E.get("content-type"),L=A&&A.startsWith("application/json");let w;if(s.method!=="HEAD"&&(L?w=await r.json():w=await r.text()),!r.ok)throw w?new Error(L?w.status.message:w):new Error(r.statusText);return L&&w&&w.hasOwnProperty("status")&&w.hasOwnProperty("response")?w.response:w}function a(s,u,r){return p({url:s+(u&&Object.keys(u).length?"?"+$.param(u):"")},r)}function c(s,u,r){return p({url:s+(u&&Object.keys(u).length?"?"+$.param(u):""),method:"HEAD"},r)}function g(s,u,r){return p({url:s,method:"POST",data:u,headers:{"x-csrf-token":config.csrf_token}},r)}function d(s,u,r){return p({url:s,method:"PATCH",data:u,headers:{"x-csrf-token":config.csrf_token}},r)}function n(s,u,r){return p({url:s,method:"PUT",data:u,headers:{"x-csrf-token":config.csrf_token}},r)}function l(s,u,r){return p({url:s,method:"DELETE",data:u,headers:{"x-csrf-token":config.csrf_token}},r)}},34405:(D,T,m)=>{var P,v;P=[m(49897),m(29930)],v=function(x,k){const C={},p={delay:200,appendTo:null};C.init=a=>{const c={...p,...a},{input:g,onSelect:d}=c;app.loadJQueryUI(function(){g.autocomplete({...c,open:function(){$(this).autocomplete("widget").css("z-index",100005)},select:function(n,l){f(g,d,n,l)}})})},C.user=function(a,c,g){typeof c=="function"&&(g=c,c={}),c=c||{},C.init({input:a,onSelect:g,source:(d,n)=>{c.query=d.term,x.get("/api/users",c,function(l,s){if(l)return k.error(l);if(s&&s.users){const u=s.users.map(function(r){const E=$("<div></div>").html(r.username).text();return r&&{label:E,value:E,user:{uid:r.uid,name:r.username,slug:r.userslug,username:r.username,userslug:r.userslug,picture:r.picture,banned:r.banned,"icon:text":r["icon:text"],"icon:bgColor":r["icon:bgColor"]}}});n(u)}$(".ui-autocomplete a").attr("data-ajaxify","false")})}})},C.group=function(a,c){C.init({input:a,onSelect:c,source:(g,d)=>{socket.emit("groups.search",{query:g.term},function(n,l){if(n)return k.error(n);if(l&&l.length){const s=l.map(function(u){return u&&{label:u.name,value:u.name,group:u}});d(s)}$(".ui-autocomplete a").attr("data-ajaxify","false")})}})},C.tag=function(a,c){C.init({input:a,onSelect:c,delay:100,source:(g,d)=>{socket.emit("topics.autocompleteTags",{query:g.term,cid:ajaxify.data.cid||0},function(n,l){if(n)return k.error(n);l&&d(l),$(".ui-autocomplete a").attr("data-ajaxify","false")})}})};function f(a,c,g,d){c=c||function(){};const n=jQuery.Event("keypress");n.which=13,n.keyCode=13,setTimeout(function(){a.trigger(n)},100),c(g,d)}return C}.apply(T,P),v!==void 0&&(D.exports=v)},96349:(D,T,m)=>{var P,v;P=[m(29930),m(89336),m(49897)],v=function(x,k,C){const p={};return p.init=function(f,a){let c=null;a=a||{},a.privilege=a.privilege||"topics:read",a.states=a.states||["watching","tracking","notwatching","ignoring"],a.cacheList=a.hasOwnProperty("cacheList")?a.cacheList:!0;let g=[];Array.isArray(a.localCategories)&&(g=a.localCategories.map(u=>({...u}))),a.selectedCids=a.selectedCids||ajaxify.data.selectedCids||[];const d=f.find('[component="category-selector-search"]');if(!d.length)return;const n=d.parent('[component="category/dropdown"]').length>0||d.parent('[component="category-selector"]').length>0;f.on("show.bs.dropdown",function(){n&&(f.find(".dropdown-toggle").css({visibility:"hidden"}),d.removeClass("hidden"),d.css({"z-index":f.find(".dropdown-toggle").css("z-index")+1}));function u(){const r=d.find("input").val();r.length>1||!r&&!c?l(r,function(E){c=a.cacheList&&(c||E),s(E)}):!r&&c&&s(c)}d.on("click",function(r){r.preventDefault(),r.stopPropagation()}),d.find("input").val("").on("keyup",utils.debounce(u,300)),u()}),f.on("shown.bs.dropdown",function(){["xs","sm"].includes(utils.findBootstrapEnvironment())||d.find("input").focus()}),f.on("hide.bs.dropdown",function(){n&&(f.find(".dropdown-toggle").css({visibility:"inherit"}),d.addClass("hidden")),d.off("click"),d.find("input").off("keyup")});function l(u,r){C.get("/search/categories",{search:u,query:utils.params(),parentCid:a.parentCid||0,selectedCids:a.selectedCids,privilege:a.privilege,states:a.states,showLinks:a.showLinks},function(E,{categories:A}){if(E)return x.error(E);r(g.concat(A))})}function s(u){const r=a.selectedCids.map(String);u.forEach(function(E){E.selected=r.includes(String(E.cid))}),app.parseAndTranslate(a.template,{categoryItems:u.slice(0,200),selectedCategory:ajaxify.data.selectedCategory,allCategoriesUrl:ajaxify.data.allCategoriesUrl},function(E){f.find('[component="category/list"]').html(E.find('[component="category/list"]').html()),f.find('[component="category/list"] [component="category/no-matches"]').toggleClass("hidden",!!u.length);const A=k.Dropdown.getInstance(f.find(".dropdown-toggle").get(0));A&&A.update()})}},p}.apply(T,P),v!==void 0&&(D.exports=v)},65348:(D,T,m)=>{var P,v;P=[m(96349),m(40027),m(91749),m(17459)],v=function(x,k,C,p){const f={};return f.init=function(a,c){if(!a||!a.length)return;c=c||{};const g=c.onSelect||function(){};c.states=c.states||["watching","tracking","notwatching","ignoring"],c.template=c.template||"partials/category/selector-dropdown-left",C.fire("action:category.selector.options",{el:a,options:c}),x.init(a,c);const d={el:a,selectedCategory:null};a.on("click","[data-cid]",function(){const l=$(this);return l.hasClass("disabled")?!1:(d.selectCategory(l.attr("data-cid")),g(d.selectedCategory))});let n=d.el.find('[component="category-selector-selected"]').html();return p.translate(n,l=>{n=l}),d.selectCategory=function(l){const s=d.el.find('[data-cid="'+l+'"]');d.selectedCategory={cid:l,name:s.attr("data-name")},s.length?d.el.find('[component="category-selector-selected"]').html(s.find('[component="category-markup"]').html()):d.el.find('[component="category-selector-selected"]').html(n)},d.getSelectedCategory=function(){return d.selectedCategory},d.getSelectedCid=function(){return d.selectedCategory?d.selectedCategory.cid:0},c.hasOwnProperty("selectedCategory")&&app.parseAndTranslate(c.template,{selectedCategory:c.selectedCategory},function(l){d.el.find('[component="category-selector-selected"]').html(l.find('[component="category-selector-selected"]').html())}),d},f.modal=function(a){a=a||{},a.onSelect=a.onSelect||function(){},a.onSubmit=a.onSubmit||function(){},app.parseAndTranslate("admin/partials/categories/select-category",{message:a.message},function(c){const g=k.dialog({title:a.title||"[[modules:composer.select-category]]",message:c,buttons:{save:{label:"[[global:select]]",className:"btn-primary",callback:n}}}),d=f.init(g.find('[component="category-selector"]'),a);function n(l){return l.preventDefault(),d.selectedCategory&&(a.onSubmit(d.selectedCategory),g.modal("hide")),!1}a.openOnLoad&&g.on("shown.bs.modal",function(){g.find(".dropdown-toggle").dropdown("toggle")}),g.find("form").on("submit",n)})},f}.apply(T,P),v!==void 0&&(D.exports=v)}}]);
